/* 
 * mcp9808.c : Lab Power Supply 
 */

#include "main.h"

#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <ctype.h>
#include <stdint.h>

#include "mcp9808.h"

//#include "main.h"
// indent -gnu -br -cli2 -lp -nut -l100 mcp9808.c

//extern I2C_Control i2c_handle;
//extern char mcp9808_str[];

void
mcp9808_init (void)
{
}

#define MCP9808_ADDR (0x18 <<1) /// (n)   (0x18|((n)&7))
#define MCP9808_TEMP_REG 0x05
extern I2C_HandleTypeDef hi2c1;

uint16_t
mcp9808_reg_read (int reg)
{
  HAL_StatusTypeDef ret;
  uint8_t buf[12];
  uint16_t val16 = 0;

  // Tell MCP9808 that we want to read from the temperature register
  //  mutex_lock();  // How is this done in cube??
  buf[0] = reg;
  if (HAL_I2C_Master_Transmit (&hi2c1, MCP9808_ADDR, buf, 1, 100) == HAL_OK) {
    // Read 2 bytes from the temperature register
    if (HAL_I2C_Master_Receive (&hi2c1, MCP9808_ADDR, buf, 2, 10) == HAL_OK) {
      //Combine the bytes
      buf[0] &= 0x1F;           // Clear flag bits
      val16 = (buf[0] << 8) | buf[1];   // temperature deg C * 16
    }
  }
  return val16;
}

// int mcp9808_read_tens_deg (void)

int
mcp9808_read (float *temp_c)
{
  HAL_StatusTypeDef ret;
  uint8_t buf[12];
  uint16_t val16 = 0;
  int err = 0;

  // Tell MCP9808 that we want to read from the temperature register
  //  mutex_lock();  // How is this done in cube??
  buf[0] = MCP9808_TEMP_REG;
  ret = HAL_I2C_Master_Transmit (&hi2c1, MCP9808_ADDR, buf, 1, 1000);   // HAL_MAX_DELAY);
  if (ret != HAL_OK) {
    err = -1;
    // mutex_unlock(); // How is this done in cube??
  }
  else {
    // Read 2 bytes from the temperature register
    ret = HAL_I2C_Master_Receive (&hi2c1, MCP9808_ADDR, buf, 2, 10);    //HAL_MAX_DELAY);
    // mutex_unlock(); // How is this done in cube??
    if (ret != HAL_OK) {
      err = -1;
    }
    else {
      //Combine the bytes
      buf[0] &= 0x1F;           // Clear flag bits
      val16 = (buf[0] << 8) | buf[1];   // temperature deg C * 16
      *temp_c = val16 / 16.0;
    }
  }
  return err;
}
