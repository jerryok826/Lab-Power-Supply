http://libopencm3.org/docs/latest/stm32f1/html/group__spi__file.html#gada533027af13ff16aceb7daad049c4e4

jerryo@jerryo-desktop:~/stm32f103/stm32f103c8t6/rtos/can_enc$ st-info --probe
Found 1 stlink programmers
 serial: 523f6d06507851524329083f
openocd: "\x52\x3f\x6d\x06\x50\x78\x51\x52\x43\x29\x08\x3f"
  flash: 131072 (pagesize: 1024)
   sram: 20480
 chipid: 0x0410
  descr: F1 Medium-density device


http://www.sonic2kworld.com/blog/using-stm32f-flash-as-eeprom-the-easy-way

// Included headers
//-----------------------------------
#include "eeprom.h"
#include "stm32f0xx_flash.h"

// Functions
//-----------------------------------

//----------------------------------------------------------------------------------
// Name: ReadEE
// Function: Read data from the EEPROM
// Parameters: address, pointer to byte location where read data is to be stored
// Returns: Result of operation
//----------------------------------------------------------------------------------
int ReadEE(uint16_t address, uint8_t *Data){
	uint32_t Address = EEPROM_START_ADDRESS;		// Base address in FLASH
	uint32_t dataword;			// Temp storage for read from FLASH

	if(address > PAGE_SIZE){
		return -1;	// Address is greater than EEPROM size, return -1
	}

	// Compute the read address into the FLASH memory
	// Passed parameter does not need to know about alignment and such
	Address = Address + (address & 0xFFFC);		// Compute address from supplied address
	dataword = (*(__IO uint32_t*)(Address));  // Retrieve dword from flash memory (Warning- it can only be dword boundaries)
	*Data = *(((char *)&dataword) + (address & 0x03));
	return 0;
}

//-----------------------------------------------------------------------------------
// Name: WriteEE
// Function: Write data to the EEPROM
// Parameter: address, data
// Returns: Result of operation
//-----------------------------------------------------------------------------------
int WriteEE(uint16_t address, uint8_t Data){
	uint32_t Address = EEPROM_START_ADDRESS;
	uint32_t dataword;

	if(address > PAGE_SIZE){
		return -1;
	}


	// Compute destination write address in the FLASH
	Address = Address + (address & 0xFFFC);
	dataword = (*(__IO uint32_t*)(Address));	// Read existing content
	*(((char *)&dataword) + (address & 0x03)) = Data;  // Modify the byte in the word

	FLASH_Unlock();			// Unlock FLASH for write
	if(FLASH_ProgramWord(Address, dataword) != FLASH_COMPLETE){
		FLASH_Lock();
		return -1;
	}
	FLASH_Lock();			// Lock FLASH again

	return 0;
}

===================================
jerryo@jerryo-desktop:~/stm32f103/stm32f103c8t6/rtos/mrf24j40$ make flash
make -f Makefile.main - flash
make[1]: Entering directory '/home/jerryo/stm32f103/stm32f103c8t6/rtos/mrf24j40'
/usr/bin/st-flash  write main.bin 0x8000000
st-flash 1.5.0
2019-03-28T09:55:46 INFO usb.c: -- exit_dfu_mode
2019-03-28T09:55:46 INFO common.c: Loading device parameters....
2019-03-28T09:55:46 INFO common.c: Device connected is: F1 Medium-density device, id 0x20036410
2019-03-28T09:55:46 INFO common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x20000 bytes (128 KiB) in pages of 1024 bytes
2019-03-28T09:55:46 INFO common.c: Attempting to write 16448 (0x4040) bytes to stm32 address: 134217728 (0x8000000)
Flash page at addr: 0x08004000 erased
2019-03-28T09:55:47 INFO common.c: Finished erasing 17 pages of 1024 (0x400) bytes
2019-03-28T09:55:47 INFO common.c: Starting Flash write for VL/F0/F3/F1_XL core id
2019-03-28T09:55:47 INFO flash_loader.c: Successfully loaded flash loader in sram
 17/17 pages written
2019-03-28T09:55:48 INFO common.c: Starting verification of write complete
2019-03-28T09:55:48 INFO common.c: Flash written and verified! jolly good!
make[1]: Leaving directory '/home/jerryo/stm32f103/stm32f103c8t6/rtos/mrf24j40'

===================================
arm-none-eabi-gcc: /usr/bin/arm-none-eabi-gcc
jerryo@jerryo-desktop:~/stm32f103/stm32f103c8t6/rtos/my_wrk$ ls /usr/bin/arm*
/usr/bin/arm2hpdl                 /usr/bin/arm-none-eabi-gcc-6.3.1   /usr/bin/arm-none-eabi-nm
/usr/bin/arm-none-eabi-addr2line  /usr/bin/arm-none-eabi-gcc-ar      /usr/bin/arm-none-eabi-objcopy
/usr/bin/arm-none-eabi-ar         /usr/bin/arm-none-eabi-gcc-nm      /usr/bin/arm-none-eabi-objdump
/usr/bin/arm-none-eabi-as         /usr/bin/arm-none-eabi-gcc-ranlib  /usr/bin/arm-none-eabi-ranlib
/usr/bin/arm-none-eabi-c++        /usr/bin/arm-none-eabi-gcov        /usr/bin/arm-none-eabi-readelf
/usr/bin/arm-none-eabi-c++filt    /usr/bin/arm-none-eabi-gcov-dump   /usr/bin/arm-none-eabi-size
/usr/bin/arm-none-eabi-cpp        /usr/bin/arm-none-eabi-gcov-tool   /usr/bin/arm-none-eabi-strings
/usr/bin/arm-none-eabi-elfedit    /usr/bin/arm-none-eabi-gprof       /usr/bin/arm-none-eabi-strip
/usr/bin/arm-none-eabi-g++        /usr/bin/arm-none-eabi-ld
/usr/bin/arm-none-eabi-gcc        /usr/bin/arm-none-eabi-ld.bfd

jerryo@jerryo-desktop:~/stm32f103/stm32f103c8t6/rtos/my_wrk$ st-util
st-util 1.5.0
2019-03-05T10:33:22 INFO common.c: Loading device parameters....
2019-03-05T10:33:22 INFO common.c: Device connected is: F1 Medium-density device, id 0x20036410
2019-03-05T10:33:22 INFO common.c: SRAM size: 0x5000 bytes (20 KiB), Flash: 0x20000 bytes (128 KiB) in pages of 1024 bytes
2019-03-05T10:33:22 INFO gdb-server.c: Chip ID is 00000410, Core ID is  1ba01477.
2019-03-05T10:33:22 INFO gdb-server.c: Listening at *:4242...
2019-03-05T10:35:27 INFO gdb-server.c: Found 6 hw breakpoint registers
2019-03-05T10:35:27 INFO gdb-server.c: GDB connected.
2019-03-05T10:40:19 ERROR gdb-server.c: cannot recv: -2
2019-03-05T10:40:20 INFO gdb-server.c: Listening at *:4242...

st-util

arm-none-eabi-gdb -x gdb_cmds.txt  //  this works

arm-none-eabi-gdb -e main.elf


arm-none-eabi-gdb 

(gdb) file main.elf

(gdb) target extended-remote :4242

Remote debugging using :4242
reset_handler () at ../../cm3/vector.c:67
67		for (src = &_data_loadaddr, dest = &_data;
(gdb) bt
#0  reset_handler () at ../../cm3/vector.c:67
(gdb) bt
#0  reset_handler () at ../../cm3/vector.c:67
(gdb) layout split
Undefined command: "layout".  Try "help".
(gdb) bt
#0  reset_handler () at ../../cm3/vector.c:67

b main
b i2c_task
b 260
b 173

(gdb) bt
#0  putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:262
#1  0x08001802 in mini_putc (ch=<optimized out>, argp=0x20000b34 <ucHeap+724>) at miniprintf.c:236
#2  0x0800165a in internal_vprintf (mini=mini@entry=0x20000b2c <ucHeap+716>, format=<op
    timized out>, arg=...) at miniprintf.c:217
#3  0x08001846 in mini_vprintf0 (args=..., format=<optimized out>, cooked=1, 
36mputc=<optimized out>) at miniprintf.c:262
#4  mini_vprintf_cooked (putc=<optimized out>, format=<optimized out>, args=...) at miniprintf.c:272
#5  0x08001868 in std_printf (format=0x80028e6 "Car simulation begun.\n") at mcuio.c:46
#6  0x0800017c in console_task (arg=<optimized out>) at main.c:174
#7  0x080004d2 in uxListRemove (pxItemToRemove=<optimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)


Program received signal SIGTRAP, Trace/breakpoint trap.
0x08000f00 in vTaskSwitchContext () at rtos/tasks.c:2806
2806			taskSELECT_HIGHEST_PRIORITY_TASK();
(gdb) bt
#0  0x08000f00 in vTaskSwitchContext () at rtos/tasks.c:2806
#1  0x080005b2 in xPortPendSVHandler () at rtos/port.c:403
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb) n
putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:263
263		while ( (USART_SR(uart) & USART_SR_TXE) == 0 )
(gdb) bt
#0  putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:263
#1  0x0800181a in mini_putc (ch=<optimized out>, ar
    gp=0x20000e5c <ucHeap+1524>) at miniprintf.c:236
#2  0x08001672 in internal_vprintf (mini=mini@entry
    =0x20000e54 <ucHeap+1516>, format=<optim
    ized out>, arg=...) at miniprintf.c:217
#3  0x0800185e in mini_vprintf0 (args=..., form
    at=<optimized out>, cooked=1, putc=<optimized o
    ut>) at miniprintf.c:262
#4  mini_vprintf_cooked (putc=<optimized out>, format=<optimized o
    ut>, args=...) at miniprintf.c:272
#5  0x08001880 in std_printf (format=0x80028fe "Car simul
    ation begun.\n") at mcuio.c:46
#6  0x0800017c in console_task (arg=<optimized out>) at main
   .c:174
#7  0x080004d6 in uxListRemove (pxItemToRemove=<o
    ptimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb) print my_uart
$2 = 1
(gdb) print uartno 
$3 = <optimized out>
(gdb) bt
#0  putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:263
#1  0x0800181a in mini_putc (ch=<optimized out>, ar
    gp=0x20000e5c <ucHeap+1524>) at miniprintf.c:236
#2  0x08001672 in internal_vprintf (mini=mini@entry
    =0x20000e54 <ucHeap+1516>, format=<optim
    ized out>, arg=...) at miniprintf.c:217
#3  0x0800185e in mini_vprintf0 (args=..., form
    at=<optimized out>, cooked=1, putc=<optimized o
    ut>) at miniprintf.c:262
#4  mini_vprintf_cooked (putc=<optimized out>, format=<optimized o
    ut>, args=...) at miniprintf.c:272
#5  0x08001880 in std_printf (format=0x80028fe "Car simul
    ation begun.\n") at mcuio.c:46
#6  0x0800017c in console_task (arg=<optimized out>) at main
   .c:174
#7  0x080004d6 in uxListRemove (pxItemToRemove=<o
    ptimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb) 


^C
Program received signal SIGTRAP, Trace/breakpoint trap.
0x08000f00 in vTaskSwitchContext () at rtos/tasks.c:2806
2806			taskSELECT_HIGHEST_PRIORITY_TASK();
(gdb) n
getc_uart (uartno=uartno@entry=2) at uartlib.c:338
338		while ( (rch = get_char(uptr)) == -1 )
(gdb) bt
#0  getc_uart (uartno=uartno@entry=2) at uartlib.c:338
#1  0x080015aa in uart2_getc () at uartlib.c:462
#2  0x080001a2 in mcu_getc (dev=<optimized out>) at /home/je
   rryo/stm32f103/stm32f103c8t6//rtos/libwwg/include/mcuio.h:71
#3  std_getc () at /home/jerryo/stm32f103/stm32f103c8t6//rtos/libwwg/include/mcuio.h:87
#4  console_task (arg=<optimized out>) at main.c:181
#5  0x080004d6 in uxListRemove (pxItemToRemove=<o
    ptimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb) 
#0  getc_uart (uartno=uartno@entry=2) at uartlib.c:338
#1  0x080015aa in uart2_getc () at uartlib.c:462
#2  0x080001a2 in mcu_getc (dev=<optimized out>) at /home/je
   rryo/stm32f103/stm32f103c8t6//rtos/libwwg/include/mcuio.h:71
#3  std_getc () at /home/jerryo/stm32f103/stm32f103c8t6//rtos/libwwg/include/mcuio.h:87
#4  console_task (arg=<optimized out>) at main.c:181
#5  0x080004d6 in uxListRemove (pxItemToRemove=<o
    ptimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)

#1  0x080005b2 in xPortPendSVHandler () at rtos/port.c:403
Backtrace stopped: previous frame identical to this frame (corrupt stack?)
(gdb) n
putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:264
264		while ( (USART_SR(uart) & USART_SR_TXE) == 0 )
(gdb) bt
#0  putc_uart (uartno=<optimized out>, ch=67 'C') at uartlib.c:264
#1  0x0800181a in mini_putc (ch=<optimized out>, ar
    gp=0x20000e5c <ucHeap+1524>) at miniprintf.c:236
#2  0x08001672 in internal_vprintf (mini=mini@entry
    =0x20000e54 <ucHeap+1516>, format=<optim
    ized out>, arg=...) at miniprintf.c:217
#3  0x0800185e in mini_vprintf0 (args=..., form
    at=<optimized out>, cooked=1, putc=<optimized o
    ut>) at miniprintf.c:262
#4  mini_vprintf_cooked (putc=<optimized out>, format=<optimized o
    ut>, args=...) at miniprintf.c:272
#5  0x08001880 in std_printf (format=0x80028fe "Car simul
    ation begun.\n") at mcuio.c:46
#6  0x0800017c in console_task (arg=<optimized out>) at main
   .c:174
#7  0x080004d6 in uxListRemove (pxItemToRemove=<o
    ptimized out>) at rtos/list.c:238
Backtrace stopped: previous frame identical to this frame (corrupt stack?)


=====================================
=====================================


st-util

arm-none-eabi-gdb 

(gdb) file main.elf

(gdb) target extended-remote :4242


For help, type "help".
Type "apropos word" to search for commands related to "word".
(gdb) file main.elf
Reading symbols from main.elf...
(gdb) target extended-remote :4242
Remote debugging using :4242
reset_handler () at ../../cm3/vector.c:67
67		for (src = &_data_loadaddr, dest = &_data;
(gdb) run
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/jerryo/stm32f103/stm32f103c8t6/rtos/oled_test_big/main.elf 
^C
Program received signal SIGTRAP, Trace/breakpoint trap.
blocking_handler () at ../../cm3/vector.c:103
103	{
(gdb) bt
#0  blocking_handler () at ../../cm3/vector.c:103
#1  <signal handler called>
#2  0x08001824 in prvPortStartFirstTask () at rtos/port.c:270
#3  0x08001956 in xPortStartScheduler () at rtos/port.c:350
Backtrace stopped: Cannot access memory at address 0x20005004
(gdb) 

==============
Second try:
Program received signal SIGTRAP, Trace/breakpoint trap.
blocking_handler () at ../../cm3/vector.c:103
103	{
(gdb) bt
#0  blocking_handler () at ../../cm3/vector.c:103
#1  <signal handler called>
#2  0x08001824 in prvPortStartFirstTask () at rtos/port.c:270
#3  0x08001956 in xPortStartScheduler () at rtos/port.c:350
Backtrace stopped: Cannot access memory at address 0x20005004

// from main.map
/DISCARD/
 *(.eh_frame)
                0x0000000020004e84                . = ALIGN (0x4)
                0x0000000020004e84                end = .
                0x0000000020005000                PROVIDE (_stack = (ORIGIN (ram) + LENGTH (ram)))
OUTPUT(main.elf elf32-littlearm)

Looks like inceaseing stack size to 1k for all task correct the pronlem.

